Subject: Only print the description for indirect offsets if a match was found, and add the offset as the number to print
Upstream-Author: Christos Zoulas <christos@zoulas.com>
Date: Fri Apr 6 21:15:54 2012 +0000
Origin: FILE5_11-8-g0de3251
Last-Update: 2015-01-05

    - only print the description for indirect offsets if a match was found,
    and add the offset as the number to print.

(prequisite for CVE-2014-8117)

Index: file-5.14/src/softmagic.c
===================================================================
--- file-5.14.orig/src/softmagic.c
+++ file-5.14/src/softmagic.c
@@ -1732,7 +1732,7 @@ mget(struct magic_set *ms, const unsigne
 	case FILE_INDIRECT:
 		if (offset == 0)
 			return 0;
-		if (OFFSET_OOB(nbytes, offset, 0))
+		if (nbytes < offset)
 			return 0;
 		sbuf = ms->o.buf;
 		soffset = ms->offset;
@@ -1742,10 +1742,10 @@ mget(struct magic_set *ms, const unsigne
 		    recursion_level, BINTEST, text);
 		if ((ms->flags & MAGIC_DEBUG) != 0)
 			fprintf(stderr, "indirect @offs=%u[%d]\n", offset, rv);
-		rbuf = ms->o.buf;
-		ms->o.buf = sbuf;
-		ms->offset = soffset;
 		if (rv == 1) {
+			rbuf = ms->o.buf;
+			ms->o.buf = sbuf;
+			ms->offset = soffset;
 			if ((ms->flags & (MAGIC_MIME|MAGIC_APPLE)) == 0 &&
 			    file_printf(ms, m->desc, offset) == -1) {
 				free(rbuf);
@@ -1755,7 +1755,8 @@ mget(struct magic_set *ms, const unsigne
 				free(rbuf);
 				return -1;
 			}
-		}
+		} else
+			ms->o.buf = sbuf;
 		free(rbuf);
 		return rv;
 
